#!/bin/bash

usage="unlock-route [-h] [--help]"

tob=/usr/local/bin/tob

unset tag
test -n "$1" && {
    test $1 == --help && exec awk '/^NAME/{ok=1}ok{print}' $0  
    test $1 == -h && {
        printf "usage: %s\n" "$usage"
        exit 0
        }
    tag=$1
    test $tag == $(<@id) ||
        printf "tag %s does not match node id %s\n" $tag "$(<@id)"
    }

test -e @LOCK || exit 3  # lock file does not exist
test -s @LOCK || exit 2  # lock file is empty
nodes=($(<@LOCK) .)
locks=(${nodes[@]/%/\/@LOCK})

status=0
while read rm_error; do
    printf "unlock %s: %s\n" "$(<@id)" "$rm_error"
    case "${rm_error##*: }" in

        'No such file or directory')
            # ignore this
            ;;

        'Is a directory')
            status=1
            ;;

        *) status=1
            ;;
    esac
done <<<"$(rm ${locks[@]} 2>&1)"

exit $status

NAME
    unlock-route

EXIT VALUES
    0 -- success, locks were removed
    1 -- failed to remove one or more locks
    2 -- lock is owned by another node, no change
    3 -- object was not locked

DESCRIPTION
    The file @LOCK contains the route to reach the object node,
    while the @LOCK files in the route nodes are empty.

AUTHOR
    ken.irving@alaska.edu 2010

