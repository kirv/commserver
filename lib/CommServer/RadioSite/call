#!/bin/bash

get-attr () {
    attr=$1
    unset value
    for path in ${TOB_attribute_search_paths//:/ }; do
        test -e $path/$attr && {
            value=$(<$path/$attr)
            test "$value" == '*' &&
                value='\*'
            return 0
            }
    done
    }

main () {
    tag=${TOB_object##*[./]}
    tob ..lock-route $tag || exit 2
    trap 'tob ../unlock-route' EXIT TERM
    route=$(<@LOCK)
    base=${route%% *}
    repeaters=${route#* }
    echo $base > @base
    echo $repeaters > @route
    test "$repeaters" == $base &&{
        unset repeaters
        >@route
        }
    radio=$(<@radio)
    options="--tag $tag"
    get-attr \@prompt && options="$options --prompt $value"
    get-attr \@retries && options="$options --retries $value"
    t0=$(date +%s)
    echo tob $base.call $options $radio $repeaters
    tob $base.call $options $radio $repeaters
    elapsed=$(( $(date +%s) - $t0 ))
    tob ../unlock-route $tag
    trap - EXIT TERM
    printf "%ds to call via %s to %s\n" $elapsed $base "$repeaters"
    }

main

exit

NAME
    call -- initiate a connection to this radio site

EXIT VALUES
    0 -- success
    1 -- some failure occurred
    2 -- failed, no route to site

DESCRIPTION
    Invoke lock-route to secure a route, then invoke the call method on the
    selected base radio.


