#!/bin/bash

self=.

main () {
    id=$(<@id)
    test -s @LOCK || tob $self.lock-route $id || exit
    trap "tob $self.unlock-route" EXIT TERM
    route=$(<@LOCK)
    base=${route%% *}
    repeaters=${route#* }
    echo $base > @base
    echo $repeaters > @route
    test "$repeaters" == $base &&{
        unset repeaters
        >@route
        }
    radio=$(<@radio)
    options=( --tag "$id" )
    TOB_get_attr \@prompt && options=( "${options[@]}" --prompt $attr )
    TOB_get_attr \@retries && options=( "${options[@]}" --retries $attr )
    t0=$(date +%s)
    echo tob $base.call "${options[@]}" $radio $repeaters
    tob $base.call "${options[@]}" $radio $repeaters
    elapsed=$(( $(date +%s) - $t0 ))
    test -s $base/\@session && {
        date +%s > @last-session-end-time
        tee < $base/\@session \@session | tob sessions.store
        }
    tob $self.unlock-route --no-log $id &&
        trap - EXIT TERM
    printf "%ds to call %s via %s and path <%s>\n" $elapsed $id $base "$repeaters" |
        tob log.store
    }

main

tob $self.unlock-route

exit

NAME
    call -- initiate a connection to this radio site

EXIT VALUES
    0 -- success
    1 -- some failure occurred
    2 -- failed, no route to site
    3 -- site radio is not powered

DESCRIPTION
    Invoke lock-route to secure a route, then invoke the call method on the
    selected base radio.


