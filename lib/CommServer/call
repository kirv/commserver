#!/usr/bin/perl
# !/usr/bin/perl -w
use strict;
use warnings;

use constant PROMPT => 'query: ';
print PROMPT;

while ( <> ) { # read input from the client
    chomp;
    s/\r//;

    if ( m/^\s*$/ ) { } # skip blank lines 

    elsif ( m/^\s*#/ ) { } # skip comment lines

    elsif ( m/^h(elp)?$/i ) { # action command
        help_screen();
        }

    elsif ( m/^q(uit)?$/i ) { # action command
        print "goodbye!\n";
        exit 0;
        }

    elsif ( m/^list\s*(.*)?$/i ) { # list sites command
        system "ls $1";
        }

    elsif ( m/^call\s+(.+)$/ ) { # load and call with query parameters
        my $site = $1;

        unless ( -e $site ) { # try alternate ways to resolve site
            if ( -e "_/$site" ) {
                $site = '_/' . $site;
                }
            elsif ( -e "_/transition/$site" ) {
                open TRANSITIONS, '>>', '@transitions' or warn $!;
                print TRANSITIONS $site, "\n";
                close TRANSITIONS or warn $!;
                $site = '_/transition/' . $site;
                }
            else {
                open FAILED, '>>', '@failed' or warn $!;
                print FAILED $site, "\n";
                close FAILED or warn $!;
                die "unable to resolve $site\n";
                }
            }

        exec "tob $site.call"
            if -d $site;
        warn "site not found: $site\n";
        }

    else {
        print "unknown query: $_\n";
        }
    print PROMPT;
    }

exit 0;

sub help_screen {
    print << "    END_HELP";
    list -- list all sites
    help -- display this message
    quit -- close down session
    call -- call specified site
    END_HELP
    
    }

